<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Wallet Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0b0b">

<style>
body{background:#0b0b0b;color:#00ff88;font-family:monospace;margin:0;text-align:center}
button{padding:12px;border:none;border-radius:10px;background:#111;color:#00ff88;font-size:18px}
.display{width:240px;height:50px;margin:20px auto;background:#000;border-radius:10px;font-size:26px;display:flex;align-items:center;justify-content:center}
.keypad{display:grid;grid-template-columns:repeat(3,80px);gap:15px;justify-content:center;margin-top:20px}
.key{width:80px;height:80px;font-size:22px;border-radius:12px}

#addBtn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;font-size:28px;background:#00ff88;color:#000}

.carousel{
 display:flex;
 overflow-x:auto;
 scroll-snap-type:x mandatory;
 padding:20px;
 gap:20px;
}

.card{
 min-width:100%;
 scroll-snap-align:center;
 background:#111;
 border-radius:12px;
 padding:15px;
 position:relative;
}

.card img{width:100%;border-radius:10px}

.popup{
position:fixed;
top:0;left:0;right:0;bottom:0;
background:#000;
padding:20px;
display:none;
overflow:auto;
}

input,select{
width:90%;
padding:12px;
margin:6px;
background:#fff;
color:#000;
border:none;
border-radius:8px;
}

.deleteBtn{
position:absolute;
top:10px;
right:10px;
background:#ff4444;
color:#fff;
padding:6px 10px;
font-size:14px;
}

.previewBox{margin-top:15px}
</style>
</head>

<body>

<!-- PIN LOCK -->
<div id="lock">
<h2 id="lockTitle">Create 4 Digit PIN</h2>
<div class="display" id="display"></div>

<div class="keypad">
<button class="key" onclick="press(1)">1</button>
<button class="key" onclick="press(2)">2</button>
<button class="key" onclick="press(3)">3</button>
<button class="key" onclick="press(4)">4</button>
<button class="key" onclick="press(5)">5</button>
<button class="key" onclick="press(6)">6</button>
<button class="key" onclick="press(7)">7</button>
<button class="key" onclick="press(8)">8</button>
<button class="key" onclick="press(9)">9</button>
<button class="key" onclick="clearCode()">C</button>
<button class="key" onclick="press(0)">0</button>
<button class="key" onclick="submitPIN()">OK</button>
</div>
</div>

<!-- MAIN -->
<div id="main" style="display:none">
<h2>QR Wallet Pro</h2>
<div class="carousel" id="qrList"></div>
</div>

<button id="addBtn" onclick="openPopup()" style="display:none">+</button>

<!-- GENERATOR POPUP -->
<div id="popup" class="popup">
<h3>Create QR</h3>

<input id="qrTitle" placeholder="Title">

<select id="qrType" onchange="buildFields()">
<option value="text">Plain Text</option>
<option value="link">Website Link</option>
<option value="contact">Contact (vCard)</option>
<option value="social">Social Links</option>
<option value="wifi">WiFi</option>
</select>

<div id="dynamicFields"></div>

<button onclick="addRow()">+ Add Row</button>
<button onclick="generateQR()">Generate QR</button>

<div class="previewBox" id="preview"></div>

<button onclick="saveQR()">SAVE</button>
<button onclick="closePopup()">CANCEL</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>

/* PIN SYSTEM */
let entered="";
function press(n){entered+=n;display.innerText="â€¢".repeat(entered.length);}
function clearCode(){entered="";display.innerText="";}

function submitPIN(){
 let saved=localStorage.getItem("qrPIN");
 if(!saved){
  if(entered.length!==4){alert("Enter 4 digit PIN");return;}
  localStorage.setItem("qrPIN",entered);
  alert("PIN saved");
  entered="";display.innerText="";
  lockTitle.innerText="Enter PIN";
  return;
 }
 if(entered===saved){
  lock.style.display="none";
  main.style.display="block";
  addBtn.style.display="block";
  loadQR();
 }else alert("Wrong PIN");
 clearCode();
}
if(localStorage.getItem("qrPIN")) lockTitle.innerText="Enter PIN";

/* INDEXED DB */
let db;
let request=indexedDB.open("qrVault",1);
request.onupgradeneeded=e=>{
 db=e.target.result;
 db.createObjectStore("qrStore",{keyPath:"id",autoIncrement:true});
};
request.onsuccess=e=>{db=e.target.result; loadQR();};

/* BUILD DEFAULT FIELDS */
function buildFields(){
 let type=qrType.value;
 dynamicFields.innerHTML="";

 if(type==="text") addRow("Text");

 if(type==="link"){
  addRow("URL");
  addRow("Title");
 }

 if(type==="contact"){
  addRow("Name");
  addRow("Phone");
  addRow("Email");
 }

 if(type==="social"){
  addRow("Instagram");
  addRow("WhatsApp");
  addRow("LinkedIn");
 }

 if(type==="wifi"){
  addRow("SSID");
  addRow("Password");
  addRow("Security");
 }
}

function addRow(label="Extra"){
 let div=document.createElement("div");
 div.innerHTML=`<input placeholder="${label}">`;
 dynamicFields.appendChild(div);
}

/* QR GENERATION */
let generatedData="";
let generatedImage="";

function generateQR(){
 let type=qrType.value;
 let values=[...dynamicFields.querySelectorAll("input")].map(i=>i.value);

 if(type==="text") generatedData=values.join("\n");

 if(type==="link") generatedData=values[0];

 if(type==="contact"){
 generatedData=`BEGIN:VCARD
VERSION:3.0
FN:${values[0]}
TEL:${values[1]}
EMAIL:${values[2]}
END:VCARD`;
 }

 if(type==="social") generatedData=values.join("\n");

 if(type==="wifi"){
 generatedData=`WIFI:T:WPA;S:${values[0]};P:${values[1]};;`;
 }

 preview.innerHTML="";
 QRCode.toDataURL(generatedData,{width:300},(err,url)=>{
  generatedImage=url;
  preview.innerHTML=`<img src="${url}" style="width:100%">`;
 });
}

/* SAVE */
function saveQR(){
 if(!generatedImage){alert("Generate QR first");return;}
 let title=qrTitle.value || "QR";

 let tx=db.transaction("qrStore","readwrite");
 let store=tx.objectStore("qrStore");

 store.add({
  title:title,
  image:generatedImage,
  data:generatedData
 });

 closePopup();
 loadQR();
}

/* LOAD + LAZY SWIPE */
function loadQR(){
 let tx=db.transaction("qrStore","readonly");
 let store=tx.objectStore("qrStore");
 let req=store.getAll();

 req.onsuccess=()=>{
  qrList.innerHTML="";
  req.result.forEach(item=>{
   qrList.innerHTML+=`
   <div class="card">
    <button class="deleteBtn" onclick="deleteQR(${item.id})">Delete</button>
    <h4>${item.title}</h4>
    <img src="${item.image}" loading="lazy" ondblclick="copyData('${item.data}')">
   </div>`;
  });
 };
}

/* DELETE */
function deleteQR(id){
 if(!confirm("Delete QR?")) return;
 let tx=db.transaction("qrStore","readwrite");
 tx.objectStore("qrStore").delete(id);
 loadQR();
}

/* COPY */
function copyData(d){
 navigator.clipboard.writeText(d);
 alert("Copied");
}

/* POPUP */
function openPopup(){popup.style.display="block"; buildFields();}
function closePopup(){popup.style.display="none";}

/* PWA */
if ("serviceWorker" in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
