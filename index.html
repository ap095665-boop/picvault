<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Wallet</title>

<style>
body{background:#0b0b0b;color:#00ff88;font-family:monospace;margin:0;text-align:center}
button{padding:12px;border:none;border-radius:10px;background:#111;color:#00ff88;font-size:18px}
.display{width:240px;height:50px;margin:20px auto;background:#000;border-radius:10px;font-size:26px;display:flex;align-items:center;justify-content:center}
.keypad{display:grid;grid-template-columns:repeat(3,80px);gap:15px;justify-content:center;margin-top:20px}
.key{width:80px;height:80px;font-size:22px;border-radius:12px}

#addBtn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;font-size:28px;background:#00ff88;color:#000}

.carousel{display:flex;overflow-x:auto;gap:20px;padding:20px;scroll-snap-type:x mandatory}
.card{min-width:100%;background:#111;border-radius:12px;padding:15px;scroll-snap-align:center}
.card img{width:100%;border-radius:10px}

.popup{position:fixed;top:0;left:0;right:0;bottom:0;background:#000;padding:20px;display:none}
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0b0b">
</head>

<body>

<!-- PIN -->
<div id="lock">
<h2 id="lockTitle">Create 4 Digit PIN</h2>
<div class="display" id="display"></div>

<div class="keypad">
<button class="key" onclick="press(1)">1</button>
<button class="key" onclick="press(2)">2</button>
<button class="key" onclick="press(3)">3</button>
<button class="key" onclick="press(4)">4</button>
<button class="key" onclick="press(5)">5</button>
<button class="key" onclick="press(6)">6</button>
<button class="key" onclick="press(7)">7</button>
<button class="key" onclick="press(8)">8</button>
<button class="key" onclick="press(9)">9</button>
<button class="key" onclick="clearCode()">C</button>
<button class="key" onclick="press(0)">0</button>
<button class="key" onclick="submitPIN()">OK</button>
</div>
</div>

<!-- MAIN -->
<div id="main" style="display:none">
<h2>QR Wallet</h2>
<div class="carousel" id="qrList"></div>
</div>

<button id="addBtn" onclick="openChoice()" style="display:none">+</button>

<!-- CHOICE POPUP -->
<div id="choicePopup" class="popup">
<h3>Add QR</h3>
<button onclick="openUpload()">Upload QR</button>
<br><br>
<button onclick="openGenerate()">Generate QR</button>
<br><br>
<button onclick="closeChoice()">Cancel</button>
</div>

<!-- UPLOAD POPUP -->
<div id="uploadPopup" class="popup">
<h3>Upload QR</h3>
<input id="qrTitle" placeholder="Title">
<br><br>
<input type="file" accept="image/*" onchange="loadImage(event)">
<br><br>
<input id="qrText" placeholder="Detected text">
<br><br>
<button onclick="saveUpload()">Save</button>
<button onclick="closeUpload()">Cancel</button>
</div>

<!-- GENERATOR POPUP -->
<div id="generatePopup" class="popup">
<h3>Generate QR</h3>
<input id="genTitle" placeholder="Title">
<br><br>
<input id="genData" placeholder="Enter UPI / text / link">
<br><br>
<canvas id="genCanvas" style="background:#fff;border-radius:10px"></canvas>
<br><br>
<button onclick="generateQR()">Generate</button>
<button onclick="saveGenerated()">Save</button>
<button onclick="closeGenerate()">Cancel</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>

// PIN
let entered="";
function press(n){entered+=n;display.innerText="â€¢".repeat(entered.length);}
function clearCode(){entered="";display.innerText="";}

function submitPIN(){
 let saved=localStorage.getItem("qrPIN");
 if(!saved){
  if(entered.length!==4){alert("Enter PIN");return;}
  localStorage.setItem("qrPIN",entered);
  alert("PIN saved");
  entered="";display.innerText="";
  lockTitle.innerText="Enter PIN";
  return;
 }
 if(entered===saved){
  lock.style.display="none";
  main.style.display="block";
  addBtn.style.display="block";
  loadQR();
 }else alert("Wrong PIN");
 clearCode();
}

// DB
let db;
let req=indexedDB.open("qrVault",1);
req.onupgradeneeded=e=>{
 db=e.target.result;
 db.createObjectStore("qrStore",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
 db=e.target.result;
 loadQR();
};

// IMAGE
let tempImg="";
function loadImage(e){
 let file=e.target.files[0];
 let reader=new FileReader();
 reader.onload=evt=>{
  let img=new Image();
  img.src=evt.target.result;
  img.onload=function(){
   let canvas=document.createElement("canvas");
   let ctx=canvas.getContext("2d");
   let scale=600/img.width;
   canvas.width=600;
   canvas.height=img.height*scale;
   ctx.drawImage(img,0,0,canvas.width,canvas.height);
   tempImg=canvas.toDataURL("image/jpeg",0.7);

   let imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
   let code=jsQR(imageData.data,canvas.width,canvas.height);
   if(code) qrText.value=code.data;
  }
 };
 reader.readAsDataURL(file);
}

// SAVE UPLOAD
function saveUpload(){
 let title=qrTitle.value;
 let text=qrText.value;
 if(!title||!tempImg){alert("Add image");return;}

 let tx=db.transaction("qrStore","readwrite");
 tx.objectStore("qrStore").add({title,image:tempImg,text});
 closeUpload();
 loadQR();
}

// GENERATOR
let generatedData="";
function generateQR(){
 let data=genData.value;
 generatedData=data;
 QRCode.toCanvas(genCanvas,data,{width:300});
}

function saveGenerated(){
 let title=genTitle.value;
 let img=genCanvas.toDataURL();
 if(!title||!generatedData){alert("Generate first");return;}

 let tx=db.transaction("qrStore","readwrite");
 tx.objectStore("qrStore").add({title,image:img,text:generatedData});
 closeGenerate();
 loadQR();
}

// LOAD
function loadQR(){
 if(!db)return;
 let tx=db.transaction("qrStore","readonly");
 let req=tx.objectStore("qrStore").getAll();
 req.onsuccess=()=>{
  let html="";
  req.result.forEach(item=>{
   html+=`
   <div class="card">
   <h4>${item.title}</h4>
   <img data-src="${item.image}" ondblclick="copyQR('${item.text||""}')">
   <button onclick="deleteQR(${item.id})">Delete</button>
   </div>`;
  });
  qrList.innerHTML=html;
  lazy();
 };
}

function lazy(){
 const imgs=document.querySelectorAll("img[data-src]");
 const observer=new IntersectionObserver(entries=>{
  entries.forEach(entry=>{
   if(entry.isIntersecting){
    entry.target.src=entry.target.dataset.src;
    observer.unobserve(entry.target);
   }
  });
 },{root:qrList});
 imgs.forEach(img=>observer.observe(img));
}

// ACTIONS
function copyQR(text){navigator.clipboard.writeText(text);alert("Copied");}
function deleteQR(id){
 if(!confirm("Delete?"))return;
 let tx=db.transaction("qrStore","readwrite");
 tx.objectStore("qrStore").delete(id);
 loadQR();
}

// POPUPS
function openChoice(){choicePopup.style.display="block";}
function closeChoice(){choicePopup.style.display="none";}
function openUpload(){closeChoice();uploadPopup.style.display="block";}
function closeUpload(){uploadPopup.style.display="none";}
function openGenerate(){closeChoice();generatePopup.style.display="block";}
function closeGenerate(){generatePopup.style.display="none";}

// PWA
if("serviceWorker"in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
